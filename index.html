<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Part√≠culas elementales</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%23cc9b7a'/><circle cx='50' cy='50' r='8' fill='%23fff'/><ellipse cx='50' cy='50' rx='35' ry='15' fill='none' stroke='%23fff' stroke-width='3' opacity='0.8'/><ellipse cx='50' cy='50' rx='15' ry='35' fill='none' stroke='%23fff' stroke-width='3' opacity='0.8'/><circle cx='25' cy='35' r='4' fill='%23fff'/><circle cx='75' cy='65' r='4' fill='%23fff'/><circle cx='75' cy='35' r='4' fill='%23fff'/><circle cx='25' cy='65' r='4' fill='%23fff'/></svg>">

    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Inter', Roboto, sans-serif;
            line-height: 1.6;
            color: #e8e8e8;
            background: #1a1a1a;
            min-height: 100vh;
            padding: 0;
        }

        /* Main container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        header {
            text-align: center;
            background: linear-gradient(135deg, #cc9b7a 0%, #b88a6f 100%);
            color: white;
            padding: 48px 20px;
            margin-bottom: 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        header h1 {
            font-size: 2.25em;
            margin-bottom: 8px;
            font-weight: 500;
            letter-spacing: -0.02em;
        }

        header p {
            font-size: 1em;
            opacity: 0.95;
            font-weight: 400;
        }

        /* Loading indicator */
        .loading {
            text-align: center;
            color: #888;
            font-size: 1em;
            padding: 60px 40px;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* Error message */
        .error {
            background: #2a2a2a;
            color: #ff6b6b;
            padding: 24px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid #3a3a3a;
        }

        /* Posts container */
        #posts {
            display: grid;
            gap: 16px;
            padding-bottom: 40px;
        }

        /* Individual post card */
        .post-card {
            background: #242424;
            border-radius: 8px;
            padding: 20px 24px;
            border: 1px solid #333;
            transition: all 0.15s ease;
        }

        .post-card:hover {
            border-color: #cc9b7a;
            box-shadow: 0 2px 12px rgba(204, 155, 122, 0.2);
            background: #282828;
        }

        /* Blog source badge */
        .blog-source {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8em;
            font-weight: 500;
            margin-bottom: 10px;
            color: white;
        }

        /* Different colors for each blog */
        .blog-source.rodobo { background: #e74c3c; }
        .blog-source.shreyas { background: #3498db; }
        .blog-source.simon { background: #2ecc71; }
        .blog-source.henrik { background: #f39c12; }
        .blog-source.bonilla { background: #9b59b6; }

        /* Default color for dynamically added blogs */
        .blog-source.dynamic-blog { background: #34495e; }

        /* Post title */
        .post-title {
            font-size: 1.25em;
            margin-bottom: 8px;
            color: #e8e8e8;
            font-weight: 500;
            line-height: 1.4;
        }

        .post-title a {
            color: #e8e8e8;
            text-decoration: none;
            transition: color 0.15s;
        }

        .post-title a:hover {
            color: #cc9b7a;
        }

        /* Post metadata */
        .post-meta {
            color: #888;
            font-size: 0.875em;
            margin-bottom: 10px;
        }

        /* Post description */
        .post-description {
            color: #b0b0b0;
            line-height: 1.6;
            margin-top: 10px;
            font-size: 0.95em;
        }

        /* Read post styling */
        .post-card.read {
            opacity: 0.45;
            background: #202020;
        }

        .post-card.read .post-title a {
            color: #666;
        }

        .post-card.read .post-description {
            color: #555;
        }

        .read-badge {
            display: inline-block;
            padding: 3px 8px;
            background: #333;
            color: #888;
            border-radius: 4px;
            font-size: 0.75em;
            margin-left: 8px;
            font-weight: 500;
        }

        .read-button {
            margin-top: 16px;
            padding: 8px 16px;
            background: #cc9b7a;
            color: #1a1a1a;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875em;
            font-weight: 500;
            transition: background 0.15s;
        }

        .read-button:hover {
            background: #d4a686;
        }

        .read-button.marked-read {
            background: #333;
            color: #888;
        }

        .read-button.marked-read:hover {
            background: #3a3a3a;
        }

        /* Blog Management Section */
        .blog-management {
            background: #242424;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid #333;
        }

        .blog-management h2 {
            color: #e8e8e8;
            margin-bottom: 20px;
            font-size: 1.25em;
            font-weight: 500;
        }

        .blog-list {
            margin-bottom: 24px;
        }

        .blog-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 0;
            border-bottom: 1px solid #2a2a2a;
            transition: opacity 0.15s;
        }

        .blog-item:hover {
            opacity: 0.7;
        }

        .blog-item:last-child {
            border-bottom: none;
        }

        .blog-info {
            flex: 1;
        }

        .blog-info-name {
            font-weight: 500;
            color: #e8e8e8;
            margin-bottom: 4px;
            font-size: 0.95em;
        }

        .blog-info-url {
            font-size: 0.825em;
            color: #888;
            word-break: break-all;
        }

        .delete-blog-btn {
            padding: 6px 14px;
            background: #2a2a2a;
            color: #ff6b6b;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 500;
            transition: all 0.15s;
            margin-left: 12px;
        }

        .delete-blog-btn:hover {
            background: #333;
            border-color: #ff6b6b;
        }

        .add-blog-form {
            display: grid;
            gap: 16px;
            margin-top: 24px;
            padding-top: 24px;
            border-top: 1px solid #2a2a2a;
        }

        .add-blog-form h3 {
            color: #e8e8e8;
            font-size: 1em;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-weight: 500;
            color: #b0b0b0;
            font-size: 0.875em;
        }

        .form-group input {
            padding: 10px 12px;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            font-size: 0.95em;
            transition: all 0.15s;
            font-family: inherit;
            background: #2a2a2a;
            color: #e8e8e8;
        }

        .form-group input:focus {
            outline: none;
            border-color: #cc9b7a;
            box-shadow: 0 0 0 3px rgba(204, 155, 122, 0.15);
        }

        .add-blog-btn {
            padding: 10px 20px;
            background: #cc9b7a;
            color: #1a1a1a;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: background 0.15s;
            margin-top: 4px;
        }

        .add-blog-btn:hover {
            background: #d4a686;
        }

        .add-blog-btn:disabled {
            background: #3a3a3a;
            color: #666;
            cursor: not-allowed;
        }

        .toggle-management-btn {
            background: #242424;
            color: #b0b0b0;
            border: 1px solid #333;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.15s;
            margin-bottom: 24px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .toggle-management-btn:hover {
            background: #2a2a2a;
            border-color: #cc9b7a;
            color: #cc9b7a;
        }

        /* Footer */
        footer {
            text-align: center;
            color: #666;
            margin-top: 48px;
            padding: 32px 20px;
            font-size: 0.875em;
        }

        /* Responsive design for mobile */
        @media (max-width: 600px) {
            header h1 {
                font-size: 2em;
            }

            .post-card {
                padding: 18px;
            }

            .post-title {
                font-size: 1.3em;
            }

            .blog-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .delete-blog-btn {
                margin-left: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Part√≠culas elementales</h1>
            <p>Ideas fundamentales del universo digital</p>
        </header>

        <button class="toggle-management-btn" onclick="toggleBlogManagement()">
            ‚öôÔ∏è Manage Blogs
        </button>

        <div id="blog-management" class="blog-management" style="display: none;">
            <h2>Manage Your Blogs</h2>

            <div class="blog-list" id="blog-list">
                <!-- Blog items will be dynamically inserted here -->
            </div>

            <div class="add-blog-form">
                <h3>Add New Blog</h3>
                <div class="form-group">
                    <label for="blog-name">Blog Name</label>
                    <input type="text" id="blog-name" placeholder="e.g., My Favorite Blog" />
                </div>
                <div class="form-group">
                    <label for="blog-url">RSS Feed URL</label>
                    <input type="url" id="blog-url" placeholder="e.g., https://example.com/feed" />
                </div>
                <button class="add-blog-btn" onclick="addNewBlog()">
                    ‚úì Add Blog
                </button>
            </div>
        </div>

        <div id="loading" class="loading">Loading posts</div>
        <div id="posts"></div>

        <footer>
            <p>Built with HTML, CSS, and JavaScript</p>
        </footer>
    </div>

    <script>
        // ============================================================
        // BLOG MANAGEMENT FUNCTIONS
        // ============================================================

        // Default blogs to start with
        const DEFAULT_BLOGS = [
            {
                name: 'Rodobo',
                slug: 'rodobo',
                url: 'https://www.rodobo.es/feed'
            },
            {
                name: 'Shreyas Doshi',
                slug: 'shreyas',
                url: 'https://shreyasdoshi.substack.com/feed'
            },
            {
                name: 'Simon Sarris',
                slug: 'simon',
                url: 'https://simonsarris.substack.com/feed'
            },
            {
                name: 'Henrik Karlsson',
                slug: 'henrik',
                url: 'https://www.henrikkarlsson.xyz/feed'
            },
            {
                name: 'Bonillaware',
                slug: 'bonilla',
                url: 'https://bonillaware.com/feed'
            }
        ];

        // Get blogs from localStorage or use defaults
        function getBlogs() {
            const stored = localStorage.getItem('blogAggregator_blogs');
            if (stored) {
                return JSON.parse(stored);
            }
            // Initialize with defaults if nothing in localStorage
            saveBlogs(DEFAULT_BLOGS);
            return DEFAULT_BLOGS;
        }

        // Save blogs to localStorage
        function saveBlogs(blogs) {
            localStorage.setItem('blogAggregator_blogs', JSON.stringify(blogs));
        }

        // Generate slug from name
        function generateSlug(name) {
            return name.toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '');
        }

        // Color palette for blog badges
        const BLOG_COLORS = [
            '#e74c3c', // red
            '#3498db', // blue
            '#2ecc71', // green
            '#f39c12', // orange
            '#9b59b6', // purple
            '#1abc9c', // turquoise
            '#e67e22', // carrot
            '#34495e', // dark blue
            '#16a085', // green sea
            '#c0392b', // dark red
            '#27ae60', // nephritis
            '#2980b9', // belize hole
            '#8e44ad', // wisteria
            '#f1c40f', // yellow
            '#d35400'  // pumpkin
        ];

        // Get color for a blog based on its index in the list
        function getBlogColor(blogSlug) {
            const blogs = getBlogs();
            const index = blogs.findIndex(b => b.slug === blogSlug);
            return BLOG_COLORS[index % BLOG_COLORS.length];
        }

        // Toggle blog management UI
        function toggleBlogManagement() {
            const managementDiv = document.getElementById('blog-management');
            if (managementDiv.style.display === 'none') {
                managementDiv.style.display = 'block';
                renderBlogList();
            } else {
                managementDiv.style.display = 'none';
            }
        }

        // Render the list of blogs in the management UI
        function renderBlogList() {
            const blogs = getBlogs();
            const blogListDiv = document.getElementById('blog-list');

            if (blogs.length === 0) {
                blogListDiv.innerHTML = '<p style="color: #7f8c8d; text-align: center; padding: 20px;">No blogs added yet. Add your first blog below!</p>';
                return;
            }

            blogListDiv.innerHTML = blogs.map((blog, index) => `
                <div class="blog-item">
                    <div class="blog-info">
                        <div class="blog-info-name">${blog.name}</div>
                        <div class="blog-info-url">${blog.url}</div>
                    </div>
                    <button class="delete-blog-btn" onclick="deleteBlog(${index})">
                        üóëÔ∏è Delete
                    </button>
                </div>
            `).join('');
        }

        // Add new blog
        function addNewBlog() {
            const nameInput = document.getElementById('blog-name');
            const urlInput = document.getElementById('blog-url');

            const name = nameInput.value.trim();
            const url = urlInput.value.trim();

            // Validation
            if (!name) {
                alert('Please enter a blog name');
                return;
            }

            if (!url) {
                alert('Please enter an RSS feed URL');
                return;
            }

            // Basic URL validation
            try {
                new URL(url);
            } catch (e) {
                alert('Please enter a valid URL');
                return;
            }

            // Check for duplicates
            const blogs = getBlogs();
            if (blogs.some(blog => blog.url === url)) {
                alert('This blog is already in your list');
                return;
            }

            // Add the blog
            const newBlog = {
                name: name,
                slug: generateSlug(name),
                url: url
            };

            blogs.push(newBlog);
            saveBlogs(blogs);

            // Clear inputs
            nameInput.value = '';
            urlInput.value = '';

            // Refresh the list
            renderBlogList();

            // Reload posts
            alert('Blog added! Refreshing posts...');
            init();
        }

        // Delete blog
        function deleteBlog(index) {
            const blogs = getBlogs();
            const blogName = blogs[index].name;

            if (confirm(`Are you sure you want to remove "${blogName}"?`)) {
                blogs.splice(index, 1);
                saveBlogs(blogs);
                renderBlogList();

                // Reload posts
                init();
            }
        }

        // CORS proxy to bypass browser restrictions
        const CORS_PROXY = 'https://corsproxy.io/?';

        // Function to fetch a single RSS feed
        async function fetchFeed(blog) {
            console.log(`Fetching ${blog.name} from ${blog.url}`);

            try {
                const proxyUrl = CORS_PROXY + encodeURIComponent(blog.url);
                console.log(`Using proxy: ${proxyUrl}`);

                const response = await fetch(proxyUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/rss+xml, application/xml, text/xml'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const text = await response.text();
                console.log(`Successfully fetched ${blog.name}, length: ${text.length}`);
                return { blog, xml: text, success: true };
            } catch (error) {
                console.error(`Error fetching ${blog.name}:`, error);
                updateStatus(`Failed to load ${blog.name}: ${error.message}`);
                return { blog, error, success: false };
            }
        }

        // Function to update status message
        function updateStatus(message) {
            const loading = document.getElementById('loading');
            if (loading && loading.style.display !== 'none') {
                loading.innerHTML = message;
            }
        }

        // Function to parse RSS/Atom XML and extract posts
        function parseFeed(feedData) {
            if (!feedData.success) return [];

            const parser = new DOMParser();
            const doc = parser.parseFromString(feedData.xml, 'text/xml');
            const posts = [];

            // Check if it's RSS or Atom format
            const isAtom = doc.querySelector('feed');

            if (isAtom) {
                // Parse Atom feed
                const entries = doc.querySelectorAll('entry');
                entries.forEach(entry => {
                    const content = entry.querySelector('summary, content')?.textContent || '';
                    posts.push({
                        title: entry.querySelector('title')?.textContent || 'No title',
                        link: entry.querySelector('link')?.getAttribute('href') || '#',
                        date: new Date(entry.querySelector('published, updated')?.textContent || Date.now()),
                        description: cleanDescription(content),
                        blogName: feedData.blog.name,
                        blogSlug: feedData.blog.slug
                    });
                });
            } else {
                // Parse RSS feed
                const items = doc.querySelectorAll('item');
                items.forEach(item => {
                    const content = item.querySelector('description, content\\:encoded')?.textContent || '';
                    posts.push({
                        title: item.querySelector('title')?.textContent || 'No title',
                        link: item.querySelector('link')?.textContent || '#',
                        date: new Date(item.querySelector('pubDate')?.textContent || Date.now()),
                        description: cleanDescription(content),
                        blogName: feedData.blog.name,
                        blogSlug: feedData.blog.slug
                    });
                });
            }

            return posts;
        }

        // Function to clean and truncate description text
        function cleanDescription(text) {
            // Remove HTML tags
            const temp = document.createElement('div');
            temp.innerHTML = text;
            let cleaned = temp.textContent || temp.innerText || '';

            // Truncate to 200 characters
            if (cleaned.length > 200) {
                cleaned = cleaned.substring(0, 200) + '...';
            }

            return cleaned;
        }

        // Function to format date nicely
        function formatDate(date) {
            const now = new Date();

            // Reset time to midnight for accurate day comparison
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const postDate = new Date(date.getFullYear(), date.getMonth(), date.getDate());

            // Calculate difference in calendar days
            const diffTime = today - postDate;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;

            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        // ============================================================
        // READ STATUS FUNCTIONS
        // ============================================================

        // Function to get read posts from localStorage
        function getReadPosts() {
            const stored = localStorage.getItem('blogAggregator_readPosts');
            return stored ? JSON.parse(stored) : [];
        }

        // Function to save read posts to localStorage
        function saveReadPosts(readPosts) {
            localStorage.setItem('blogAggregator_readPosts', JSON.stringify(readPosts));
        }

        // Function to check if a post is read
        function isPostRead(postLink) {
            const readPosts = getReadPosts();
            return readPosts.includes(postLink);
        }

        // Function to toggle read/unread status
        function toggleReadStatus(postLink, button, postCard) {
            const readPosts = getReadPosts();
            const isRead = readPosts.includes(postLink);

            if (isRead) {
                // Mark as unread
                const index = readPosts.indexOf(postLink);
                readPosts.splice(index, 1);
                postCard.classList.remove('read');
                button.textContent = '‚úì Mark as Read';
                button.classList.remove('marked-read');
            } else {
                // Mark as read
                readPosts.push(postLink);
                postCard.classList.add('read');
                button.textContent = '‚Ü© Mark as Unread';
                button.classList.add('marked-read');
            }

            saveReadPosts(readPosts);
        }

        // Function to display posts in the DOM
        function displayPosts(posts) {
            const postsContainer = document.getElementById('posts');
            const loadingIndicator = document.getElementById('loading');

            // Hide loading indicator
            loadingIndicator.style.display = 'none';

            if (posts.length === 0) {
                postsContainer.innerHTML = `
                    <div class="error">
                        <h3>Unable to load posts</h3>
                        <p>This could be due to:</p>
                        <ul style="text-align: left; margin: 10px auto; max-width: 400px;">
                            <li>CORS proxy being blocked or rate-limited</li>
                            <li>Network connectivity issues</li>
                            <li>RSS feeds temporarily unavailable</li>
                        </ul>
                        <p style="margin-top: 15px;">Open browser console (F12) to see detailed errors.</p>
                        <button onclick="location.reload()" style="margin-top: 15px; padding: 10px 20px; background: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em;">
                            Try Again
                        </button>
                    </div>
                `;
                return;
            }

            // Sort posts by date (newest first)
            posts.sort((a, b) => b.date - a.date);

            // Create HTML for each post with read status
            postsContainer.innerHTML = posts.map((post, index) => {
                const isRead = isPostRead(post.link);
                const readClass = isRead ? 'read' : '';
                const readBadge = isRead ? '<span class="read-badge">Read</span>' : '';
                const buttonText = isRead ? '‚Ü© Mark as Unread' : '‚úì Mark as Read';
                const buttonClass = isRead ? 'read-button marked-read' : 'read-button';
                const blogColor = getBlogColor(post.blogSlug);

                return `
                    <article class="post-card ${readClass}" data-post-index="${index}">
                        <span class="blog-source" style="background: ${blogColor};">${post.blogName}</span>${readBadge}
                        <h2 class="post-title">
                            <a href="${post.link}" target="_blank" rel="noopener noreferrer">
                                ${post.title}
                            </a>
                        </h2>
                        <div class="post-meta">
                            ${formatDate(post.date)}
                        </div>
                        <p class="post-description">${post.description}</p>
                        <button class="${buttonClass}" data-post-link="${post.link}">
                            ${buttonText}
                        </button>
                    </article>
                `;
            }).join('');

            // Attach event listeners to read buttons
            const readButtons = postsContainer.querySelectorAll('.read-button');
            readButtons.forEach((button) => {
                button.addEventListener('click', function() {
                    const postLink = this.getAttribute('data-post-link');
                    const postCard = this.closest('.post-card');
                    toggleReadStatus(postLink, this, postCard);
                });
            });
        }

        // Main function to initialize the app
        async function init() {
            try {
                updateStatus('Fetching feeds...');

                // Get blogs from localStorage
                const blogs = getBlogs();

                if (blogs.length === 0) {
                    document.getElementById('loading').innerHTML =
                        '<div class="error">No blogs configured. Click "Manage Blogs" to add some!</div>';
                    return;
                }

                // Fetch all feeds in parallel
                const feedPromises = blogs.map(blog => fetchFeed(blog));
                const feedResults = await Promise.all(feedPromises);

                updateStatus('Parsing posts...');

                // Parse all feeds and combine posts
                const allPosts = feedResults.flatMap(result => parseFeed(result));

                console.log(`Total posts found: ${allPosts.length}`);

                // Count successful feeds
                const successCount = feedResults.filter(r => r.success).length;
                console.log(`Successfully loaded ${successCount} out of ${blogs.length} blogs`);

                // Display the posts
                displayPosts(allPosts);

            } catch (error) {
                console.error('Error initializing app:', error);
                document.getElementById('loading').innerHTML =
                    '<div class="error">Failed to load posts. Error: ' + error.message + '</div>';
            }
        }

        // Start the app when page loads
        init();
    </script>
</body>
</html>
